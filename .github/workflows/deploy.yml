name: Deploy to GitHub Pages

on:
  push:
    branches: [main]

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install

      - name: Build ReScript
        run: pnpm res:build

      - name: Build Vite
        run: pnpm build

      - name: Verify bundle size (guard against missing createRoot / empty bundle)
        run: |
          node -e "
            const {statSync, readdirSync} = require('fs');
            const files = readdirSync('dist/assets').filter(f => f.endsWith('.js'));
            if (files.length === 0) { console.error('No JS bundles found in dist/assets'); process.exit(1); }
            const maxSize = Math.max(...files.map(f => statSync('dist/assets/' + f).size));
            const kb = (maxSize / 1024).toFixed(1);
            console.log('Largest bundle: ' + kb + ' kB');
            if (maxSize < 50000) {
              console.error('ERROR: Bundle is ' + kb + ' kB â€” app likely not mounting to DOM (missing createRoot?)');
              process.exit(1);
            }
            console.log('Bundle size OK');
          "

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: dist/

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
